<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Step 3: Grid Editor</title>
    <!-- üîó LOAD FABRIC.JS LIBRARY FOR IMAGE EDITING -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
     <style>
            /* ===== SUNDUQVAULT GRID EDITOR STYLES ===== */
                :root {
                        --primary: #0f766e;
                                --dark: #0f172a;
                                        --light: #f8fafc;
                                                --accent: #f59e0b;
                                                        --gray: #64748b;
                                                            }

                                                                * {
                                                                        margin: 0;
                                                                                padding: 0;
                                                                                        box-sizing: border-box;
                                                                                                font-family: 'Segoe UI', system-ui, sans-serif;
                                                                                                    }

                                                                                                        body {
                                                                                                                background: linear-gradient(135deg, var(--dark) 0%, #1e293b 100%);
                                                                                                                        min-height: 100vh;
                                                                                                                                color: var(--light);
                                                                                                                                        padding: 40px 20px;
                                                                                                                                                /* NO FLEX - natural flow */
                                                                                                                                                        text-align: center;
                                                                                                                                                            }

                                                                                                                                                                /* Headers */
                                                                                                                                                                    h1 {
                                                                                                                                                                            font-size: 2.2rem;
                                                                                                                                                                                    margin-bottom: 15px;
                                                                                                                                                                                            background: linear-gradient(90deg, var(--accent), var(--primary));
                                                                                                                                                                                                    -webkit-background-clip: text;
                                                                                                                                                                                                            -webkit-text-fill-color: transparent;
                                                                                                                                                                                                                    font-weight: 800;
                                                                                                                                                                                                                        }

                                                                                                                                                                                                                            p {
                                                                                                                                                                                                                                    color: #94a3b8;
                                                                                                                                                                                                                                            margin-bottom: 30px;
                                                                                                                                                                                                                                                    max-width: 600px;
                                                                                                                                                                                                                                                            margin-left: auto;
                                                                                                                                                                                                                                                                    margin-right: auto;
                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                            /* Canvas container */
                                                                                                                                                                                                                                                                                #previewArea {
                                                                                                                                                                                                                                                                                        background: rgba(255, 255, 255, 0.05) !important;
                                                                                                                                                                                                                                                                                                border: 2px solid rgba(255, 255, 255, 0.1) !important;
                                                                                                                                                                                                                                                                                                        border-radius: 16px !important;
                                                                                                                                                                                                                                                                                                                padding: 20px !important;
                                                                                                                                                                                                                                                                                                                        margin: 30px auto !important;
                                                                                                                                                                                                                                                                                                                                width: 600px !important;
                                                                                                                                                                                                                                                                                                                                        height: 850px !important;
                                                                                                                                                                                                                                                                                                                                                display: inline-block;
                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                        /* Controls */
                                                                                                                                                                                                                                                                                                                                                            .controls {
                                                                                                                                                                                                                                                                                                                                                                    background: rgba(255, 255, 255, 0.05);
                                                                                                                                                                                                                                                                                                                                                                            padding: 20px;
                                                                                                                                                                                                                                                                                                                                                                                    border-radius: 16px;
                                                                                                                                                                                                                                                                                                                                                                                            margin: 20px auto;
                                                                                                                                                                                                                                                                                                                                                                                                    max-width: 600px;
                                                                                                                                                                                                                                                                                                                                                                                                            text-align: center;
                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                    .controls h3 {
                                                                                                                                                                                                                                                                                                                                                                                                                            color: var(--light);
                                                                                                                                                                                                                                                                                                                                                                                                                                    margin-bottom: 15px;
                                                                                                                                                                                                                                                                                                                                                                                                                                            font-size: 1.3rem;
                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                    .controls button {
                                                                                                                                                                                                                                                                                                                                                                                                                                                            background: var(--primary) !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    color: white !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            border: none !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    padding: 12px 24px !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            border-radius: 8px !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    margin: 8px !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cursor: pointer !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    font-weight: 600 !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            display: inline-block !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    width: auto !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            .controls button:hover {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    background: #0d9488 !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            transform: translateY(-2px) !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    input[type="file"] {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            background: rgba(255, 255, 255, 0.08);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    border: 2px solid rgba(255, 255, 255, 0.1);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            border-radius: 8px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    color: var(--light);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            padding: 10px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    margin: 10px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            width: 200px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    /* Navigation button */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        button[onclick="goToSummary()"] {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                background: linear-gradient(135deg, var(--primary), #0d9488) !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        border: none !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                border-radius: 12px !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        padding: 18px 30px !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                color: white !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        font-size: 1.2rem !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                font-weight: 700 !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        cursor: pointer !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                margin: 30px auto !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        display: block !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                text-align: center !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        max-width: 400px;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                button[onclick="goToSummary()"]:hover {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        transform: translateY(-3px) !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4) !important;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </style>
</head>
<body>
    <h1>üé® STEP 3: FILL YOUR GRIDS</h1>
    <p>Upload an image for each grid. Drag, resize, and rotate!</p>

    <div id="previewArea" style="
        background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
                border-radius: 16px;
                    padding: 20px;
                        margin: 30px auto;
                            width: 95%;
                                max-width: 1000px;
                                    overflow: auto;
                                        text-align: center;
                                        ">
                                            <canvas id="previewCanvas" width="2480" height="3508" style="
                                                    max-width: 100%;
                                                            height: auto;
                                                                    border: 1px solid #ccc;
                                                                        "></canvas>
                                                                        </div>

    <!-- üéØ CONTROLS FOR THE SELECTED GRID -->
    <div class="controls">
        <h3>üõ†Ô∏è EDIT SELECTED GRID</h3>
        <input type="file" id="imageUpload" accept="image/*">
        <button onclick="rotateImage()">üîÑ Rotate</button>
        <button onclick="deleteImage()">üóëÔ∏è Delete Image</button>
        <p>Click on a grid to select it, then upload or edit.</p>
    </div>

    <!-- üöÄ NAVIGATION -->
    <div style="text-align: center; margin-top: 30px;">
        <button style="padding: 15px 30px; font-size: 1.2rem; background: #0d9488; color: white;" onclick="goToSummary()">
            ‚úÖ GO TO ORDER SUMMARY (STEP 4)
        </button>
    </div>

    <script>
        // üß† GET DATA FROM PREVIOUS SCREEN
        const orientation = localStorage.getItem('stickerOrientation');
        const layout = localStorage.getItem('stickerLayout');
        const totalGrids = parseInt(localStorage.getItem('stickerGrids'));
        const pricePerGrid = parseFloat(localStorage.getItem('pricePerGrid'));

        // üé® SETUP FABRIC CANVAS
        const canvas = new fabric.Canvas('previewCanvas');
        const canvasWidth = 600;
        const canvasHeight = 850;
        let activeGridIndex = null;

        // üìè CALCULATE GRID POSITIONS (SIMPLIFIED MATH)
        let gridWidth, gridHeight, cols, rows;
        if (layout === 'full') { cols = 1; rows = 1; }
        if (layout === 'half') { cols = 1; rows = 2; } // Portrait: 2 vertical grids
        if (layout === 'quarter') { cols = 2; rows = 2; }
        if (layout === 'eight') { cols = 2; rows = 4; }

        gridWidth = canvasWidth / cols;
        gridHeight = canvasHeight / rows;

       // üü¶ DRAW THE EMPTY GRIDS WITH UPLOAD BUTTONS
for (let row = 0; row < rows; row++) {
    for (let col = 0; col < cols; col++) {
        const gridIndex = row * cols + col;
        if (gridIndex >= totalGrids) break;

        // Create the grid rectangle
        const rect = new fabric.Rect({
            left: col * gridWidth,
            top: row * gridHeight,
            width: gridWidth - 2,
            height: gridHeight - 2,
            fill: 'white',
            stroke: '#0d9488',
            strokeWidth: 2,
            selectable: false,
            name: `grid-${gridIndex}`
        });
        canvas.add(rect);

        // üÜï CREATE AN INVISIBLE UPLOAD BUTTON OVER THE GRID
        // We'll make a transparent rectangle that acts as a button
        const buttonZone = new fabric.Rect({
            left: col * gridWidth,
            top: row * gridHeight,
            width: gridWidth - 2,
            height: gridHeight - 2,
            fill: 'rgba(13, 148, 136, 0.05)', // Almost transparent
            stroke: 'transparent',
            selectable: false,
            name: `upload-btn-${gridIndex}`,
            hoverCursor: 'pointer'
        });
        
        // üÜï WHEN THIS INVISIBLE BUTTON IS CLICKED
        buttonZone.on('mousedown', function() {
            // Create a hidden file input
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = 'image/*';
            fileInput.style.display = 'none';
            
            // When a file is chosen
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    fabric.Image.fromURL(event.target.result, function(img) {
                        // Scale image to fit grid
                        const scale = Math.min(
                            (gridWidth - 20) / img.width,
                            (gridHeight - 20) / img.height
                        );
                        img.scale(scale);
                        
                        // Center in the grid
                        img.set({
                            left: col * gridWidth + (gridWidth / 2),
                            top: row * gridHeight + (gridHeight / 2),
                            originX: 'center',
                            originY: 'center',
                            name: `image-for-grid-${gridIndex}`,
                            selectable: true // ‚úÖ User can now click and rotate this image!
                        });
                        
                        canvas.add(img);
                        canvas.renderAll();
                        // ========== CRITICAL BUG FIX ==========
                        // Remove the invisible upload button for this grid
                        const buttonName = `upload-btn-${gridIndex}`;
                        const uploadButton = canvas.getObjects().find(obj => obj.name === buttonName);
                        if (uploadButton) {
                            canvas.remove(uploadButton);
                            }
                            // Remove the "Click to upload" text label
                            const labelName = `label-for-grid-${gridIndex}`;
                            const label = canvas.getObjects().find(obj => obj.name === labelName);
                            if (label) {
                                canvas.remove(label);
                                }
                                canvas.renderAll(); // Update the canvas
                                // ========== FIX ENDS ==========
                    });
                };
                reader.readAsDataURL(file);
            };
            
            // Trigger the file selection dialog
            document.body.appendChild(fileInput);
            fileInput.click();
            document.body.removeChild(fileInput);
        });
        
        canvas.add(buttonZone);
        
        // üÜï ADD A TEXT LABEL INSIDE EMPTY GRID
        const labelText = new fabric.Text(`Grid ${gridIndex + 1}\n(Click to upload)`, {
            left: col * gridWidth + (gridWidth / 2),
            top: row * gridHeight + (gridHeight / 2),
            originX: 'center',
            originY: 'center',
            fontSize: 12,
            fill: '#64748b',
            textAlign: 'center',
            selectable: false,
            name: `label-for-grid-${gridIndex}`
        });
        canvas.add(labelText);
    }
}

                // Make grid clickable to select
                rect.on('mousedown', () => {
                    activeGridIndex = gridIndex;
                    alert(`Grid ${gridIndex + 1} selected! Now upload an image for it.`);
                });
        

        // üì§ HANDLE IMAGE UPLOAD FOR THE SELECTED GRID
        document.getElementById('imageUpload').onchange = function(e) {
            if (activeGridIndex === null) {
                alert("‚ö†Ô∏è Click on a grid first to select it!");
                return;
            }
            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                fabric.Image.fromURL(event.target.result, function(img) {
                    // Scale image to fit the grid
                    img.scaleToWidth(gridWidth - 10);
                    img.scaleToHeight(gridHeight - 10);

                    // Center it in the selected grid
                    const col = activeGridIndex % cols;
                    const row = Math.floor(activeGridIndex / cols);
                    img.set({
                        left: col * gridWidth + (gridWidth / 2),
                        top: row * gridHeight + (gridHeight / 2),
                        originX: 'center',
                        originY: 'center',
                        name: `image-for-grid-${activeGridIndex}`
                    });

                    canvas.add(img);
                    canvas.renderAll();
                });
            };
            reader.readAsDataURL(file);
        };

        // üîÑ ROTATE THE IMAGE IN THE SELECTED GRID
        function rotateImage() {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.name && activeObject.name.startsWith('image-for-grid-')) {
                activeObject.rotate((activeObject.angle || 0) + 15);
                canvas.renderAll();
            } else {
                alert("Select an image by clicking on it first!");
            }
        }

        // üóëÔ∏è DELETE THE IMAGE FROM THE SELECTED GRID
        function deleteImage() {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                canvas.remove(activeObject);
                canvas.renderAll();
            }}
        // üíæ SAVE CANVAS AS IMAGE AND GO TO SUMMARY - FIXED VERSION
function goToSummary() {
    // üÜï COUNT ONLY UNIQUE GRIDS WITH IMAGES (FIX FOR 5/4 BUG)
    const filledGridsSet = new Set(); // Set stores only unique values
    
    canvas.getObjects().forEach(obj => {
        if (obj.name && obj.name.startsWith('image-for-grid-')) {
            // Extract grid number from name like "image-for-grid-3" ‚Üí 3
            const gridNumMatch = obj.name.match(/image-for-grid-(\d+)/);
            if (gridNumMatch) {
                const gridIndex = parseInt(gridNumMatch[1]);
                // Only count if grid index is valid (0 to totalGrids-1)
                if (!isNaN(gridIndex) && gridIndex < totalGrids) {
                    filledGridsSet.add(gridIndex);
                }
            }
        }
    });
    
    const filledGridsCount = filledGridsSet.size; // Number of unique filled grids
    
    // üÜï CALCULATE PRICE: Can't charge for more grids than exist!
    const actualFilledGrids = Math.min(filledGridsCount, totalGrids);
    const totalPrice = actualFilledGrids * pricePerGrid;
    
    // üÜï SAVE THE CORRECT DATA
    localStorage.setItem('filledGrids', actualFilledGrids);
    localStorage.setItem('totalPrice', totalPrice);
    
    // üÜï HIDE UPLOAD BUTTONS AND LABELS FROM FINAL IMAGE
    canvas.getObjects().forEach(obj => {
        if (obj.name && (obj.name.startsWith('upload-btn-') || obj.name.startsWith('label-for-grid-'))) {
            obj.visible = false;
        }
    });
    canvas.renderAll();
    
    // üÜï SAVE CANVAS AS IMAGE DATA URL
    const finalDesignUrl = canvas.toDataURL({
        format: 'png',
        quality: 1.0
    });
    
    // üÜï MAKE USER DOWNLOAD THE PREVIEW
    const downloadLink = document.createElement('a');
    downloadLink.href = finalDesignUrl;
    downloadLink.download = `SunduqVault-Design-Preview-${Date.now()}.png`;
    document.body.appendChild(downloadLink);
    downloadLink.click();
    document.body.removeChild(downloadLink);
    
    // üÜï SHOW ALERT WITH CORRECT GRID COUNT
    alert(`‚úÖ PERFECT! You filled ${actualFilledGrids} of ${totalGrids} grids.
    \nüì± Your design preview has been downloaded.
    \nIMPORTANT: Send this image file when you place your WhatsApp order!
    \nNow going to order summary...`);
    
    // GO TO SUMMARY SCREEN
    window.location.href = 'screen4.html';
}
</script>
</body>
</html>